---
import { marked } from 'marked'
import BaseLayout from '../layouts/BaseLayout.astro'
import Link from '../components/shared/Link.astro'
import HeroSection from '../components/shared/HeroSection.astro'

const token = import.meta.env.STRAPI_PREVIEW_TOKEN
const fetch_url = import.meta.env.STRAPI_URL

if (!token || !fetch_url) {
  throw new Error(`Missing Strapi config: token=${!!token}, url=${!!fetch_url}`)
}

async function getMediaFromStrapi() {
  try {
    const response = await fetch(
      // `${fetch_url}/api/media-page?populate[media_hero][populate][hero_cta]=true&populate[media_cta]=true`,
      // `${fetch_url}/api/media-page?populate[media_hero][populate][hero_cta]=true&populate[media_cta]=true&populate[dynamic][populate][section]=true&populate[dynamic][populate][cta_link]=true`,
      `${fetch_url}/api/media-page?populate[media_hero][populate][hero_cta]=true&populate[media_cta]=true&populate[dynamic]=true`,
      {
        headers: {
          Authorization: `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    )
    if (!response.ok) {
      throw new Error(`Strapi API error: ${response.status}`)
    }
    const data = await response.json()
    return data.data
  } catch (error) {
    console.error('Strapi fetch failed:', error)
    throw error
  }
}

const mediaData = await getMediaFromStrapi()
---

<BaseLayout title="Press - Interledger Developers">
  {
    mediaData && (
      <main>
        {mediaData.media_hero && (
          <HeroSection
            title={mediaData.media_hero.hero_title ?? 'title'}
            content={mediaData.media_hero.hero_content ?? 'content'}
            ctas={mediaData.media_hero.hero_cta ?? []}
          />
        )}
        {mediaData.media_content && (
          <section class="press-intro">
            <div
              class="content-wrapper"
              set:html={marked.parse(mediaData.media_content)}
            />
          </section>
        )}
        {mediaData.media_cta && (
          <section>
            <div class="content-wrapper">
              <Link
                href={mediaData.media_cta.href ?? ''}
                style={mediaData.media_cta.style ?? 'primary'}
                umami={mediaData.media_cta.umami ?? ''}
                external={mediaData.media_cta.external ?? false}
                text={mediaData.media_cta.text ?? 'Click'}
              />
            </div>
          </section>
        )}
        <section>
          <div class="content-wrapper">
            <h3>Dynamic zone underneath:</h3>
            {mediaData.dynamic && 
              <code style={{ whiteSpace: "pre-wrap" }}>{JSON.stringify(mediaData.dynamic, null, 2)}</code>
            }
            {mediaData.dynamic.map( component => {
              switch (component.__component) {
                case 'shared.cta-link':
                  return <Link
                    href={component.href}
                    style={component.style}
                    umami={component.umami}
                    external={component.external}
                    text={component.text}
                  />;
                case 'shared.section': 
                  return <p>This is a section</p>
              } 
            })

            }
          </div>
        </section>
      </main>
    )
  }
</BaseLayout>

<style>
  main {
    padding-block-end: var(--space-l);
  }

  section {
    padding-block-start: var(--space-l);
  }

  section:last-child {
    padding-block-end: var(--space-l);
  }

  .content-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-m);
  }

  .press-intro {
    background-color: var(--color-background-light);
    padding-block: var(--space-m);
  }
</style>
