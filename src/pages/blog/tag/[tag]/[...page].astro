---
import type { Page } from 'astro'
import type { GetStaticPaths } from 'astro'
import { getTagSlug } from '../../../../utils/tag-url'
import BaseLayout from '../../../../layouts/BaseLayout.astro'
import BlogIndex from '../../../../components/blog/BlogIndex.astro'
import { getCollection } from 'astro:content'

type Props = {
  page: Page
  allTags: string[]
  selectedTag: string
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const blogEntries = (await getCollection('blog')).sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime()
  )

  // Collect all unique tags
  const allTags = [
    ...new Set(blogEntries.flatMap((entry) => entry.data.tags))
  ].sort()

  // Create pages for each tag
  return allTags.flatMap((tag) => {
    const tagSlug = getTagSlug(tag)
    const filteredEntries = blogEntries.filter((entry) =>
      entry.data.tags.includes(tag)
    )

    return paginate(filteredEntries, {
      params: { tag: tagSlug },
      pageSize: 10,
      props: { allTags, selectedTag: tag }
    })
  })
}

const { page, allTags, selectedTag } = Astro.props
---

<BaseLayout
  title={`Engineering Blog - ${selectedTag}`}
  description={`Blog posts tagged with ${selectedTag}`}
  ogImageUrl={new URL('/developers/img/blog/og-image.png', Astro.site).href}
>
  <BlogIndex
    title="Engineering Blog"
    posts={page.data || []}
    breadcrumbs={[
      {
        name: 'Developers Portal',
        href: '/developers',
        umamiEvent: 'Devs breadcrumb - Home'
      },
      {
        name: 'Engineering Blog',
        href: '/developers/blog',
        umamiEvent: 'Devs breadcrumb - Blog'
      }
    ]}
    allTags={allTags}
    selectedTag={selectedTag}
    showTagFilter={true}
    showPagination={true}
    paginationProps={{
      length: page.lastPage,
      currentPage: page.currentPage,
      firstUrl: page.url.first,
      prevUrl: page.url.prev,
      nextUrl: page.url.next,
      lastUrl: page.url.last
    }}
  />
</BaseLayout>
