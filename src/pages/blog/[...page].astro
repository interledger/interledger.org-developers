---
import type { GetStaticPaths, Page } from 'astro'
import BaseLayout from '../../layouts/BaseLayout.astro'
import BlogIndex from '../../components/blog/BlogIndex.astro'
import { getCollection } from 'astro:content'
import { useTranslations, getLangFromUrl} from '../../i18n/utils';

type Props = {
  page: Page
  allTags: string[]
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const blogEntries = (await getCollection('blog'))
  .filter((entry) => entry.filePath && entry.filePath.match(/\/blog\/[^\/]+\.mdx?$/))
  .sort(
    (a, b) => b.data.date.getTime() - a.data.date.getTime()
  )

  // Collect all unique tags
  const allTags = [
    ...new Set(blogEntries.flatMap((entry) => entry.data.tags))
  ].sort()

  return paginate(blogEntries, {
    pageSize: 10,
    props: { allTags }
  })
}

const lang = getLangFromUrl(Astro.url);
const { page, allTags } = Astro.props
const t = useTranslations(lang);

---

<BaseLayout
  title={t("nav.tech-blog")}
  description={t("nav.tech-blog-description")}
  ogImageUrl={new URL('/developers/img/blog/og-image.png', Astro.site).href}
>
  <BlogIndex
    title={t("nav.tech-blog")}
    posts={page.data || []}
    breadcrumbs={[
      {
        name: t("nav.developers"),
        href: '/developers',
        umamiEvent: 'Devs breadcrumb - Home'
      }
    ]}
    allTags={allTags}
    showTagFilter={true}
    showPagination={true}
    paginationProps={{
      length: page.lastPage,
      currentPage: page.currentPage,
      firstUrl: page.url.first,
      prevUrl: page.url.prev,
      nextUrl: page.url.next,
      lastUrl: page.url.last
    }}
  />
</BaseLayout>
