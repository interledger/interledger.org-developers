---
import { getCollection, render } from 'astro:content'
import CommunityLinks from '../../components/blog/CommunityLinks.astro'
import BlogLayout from '../../layouts/BlogLayout.astro'

export const prerender = true

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog')
  return blogEntries.map((entry) => {
    const lang = entry.data.lang || 'en'
    const slug = entry.data.slug
    const id = lang === 'en' ? slug : `${lang}/${slug}`
    return {
      params: { id },
      props: { entry }
    }
  })
}

const { entry } = Astro.props
const { Content } = await render(entry)

// --- Language Switcher Logic ---

const translations = entry.data.translations || {}
const currentLang = entry.data.lang || 'en'

const localeNames: Record<string, string> = {
  en: 'English',
  es: 'Español',
  fr: 'Français'
}

const availableLocales = ['en', 'es', 'fr']

// Pre-calculate links for the template
const languageLinks = availableLocales.map(locale => {
  const isCurrent = locale === currentLang
  let link = null
  
  if (!isCurrent) {
    const slug = translations[locale]
    if (slug) {
      link = locale === 'en' ? `/blog/${slug}` : `/blog/${locale}/${slug}`
    } else {
      link = '/translation-in-progress'
    }
  }

  return {
    locale,
    name: localeNames[locale],
    isCurrent,
    link
  }
})
---

<BlogLayout frontmatter={entry.data}>
  <div class="blog-post-language-switcher">
    <div class="language-switcher" id="languageSwitcher">
      <button
        class="language-switcher__toggle"
        aria-expanded="false"
        aria-haspopup="true"
      >
        {currentLang.toUpperCase()}
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" aria-hidden="true">
          <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <ul id="language-menu" class="language-switcher__menu">
        {
          languageLinks.map((item) => (
            <li>
              <a 
                href={item.isCurrent ? '#' : item.link} 
                class={`language-switcher__link ${item.isCurrent ? 'active' : ''}`}
                aria-current={item.isCurrent ? 'page' : undefined}
              >
                {item.locale.toUpperCase()} - {item.name}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>

  <Content />
  <CommunityLinks />
</BlogLayout>

<script>
  function initLanguageSwitcher() {
    const switcher = document.getElementById('languageSwitcher')
    const toggle = switcher?.querySelector('.language-switcher__toggle')
    const menu = switcher?.querySelector('.language-switcher__menu')

    if (!switcher || !toggle || !menu) return

    const toggleMenu = (open: boolean) => {
      const isExpanded = open ? 'true' : 'false'
      toggle.setAttribute('aria-expanded', isExpanded)
      switcher.classList.toggle('is-open', open)
    }

    toggle.addEventListener('click', (e) => {
      e.stopPropagation()
      const isOpen = switcher.classList.contains('is-open')
      toggleMenu(!isOpen)
    })

    document.addEventListener('click', (e) => {
      if (!switcher.contains(e.target as Node)) {
        toggleMenu(false)
      }
    })

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        toggleMenu(false)
      }
    })
  }

  initLanguageSwitcher()
  document.addEventListener('astro:page-load', initLanguageSwitcher)
</script>

<style>
  .blog-post-language-switcher {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 24px;
    position: relative;
    z-index: 10;
  }

  /* Language Switcher */
  .language-switcher {
    position: relative;
  }

  .language-switcher__toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    background-color: white;
    border: 1.5px solid currentColor;
    border-radius: var(--border-radius);
    font-size: var(--step--1);
    font-weight: 600;
    cursor: pointer;
    transition: background-color 200ms ease;
  }

  .language-switcher__toggle:hover {
    background-color: #f5f5f5;
  }

  .language-switcher__menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 4px;
    padding: 8px 0;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    list-style: none;
    min-width: 150px;
    display: none;
    z-index: 100;
  }

  .language-switcher.is-open .language-switcher__menu {
    display: block;
  }

  .language-switcher__toggle svg {
    transition: transform 200ms ease;
  }

  .language-switcher.is-open .language-switcher__toggle svg {
    transform: rotate(180deg);
  }

  .language-switcher__menu li {
    margin: 0;
  }

  .language-switcher__link {
    display: block;
    padding: 8px 16px;
    color: inherit;
    text-decoration: none;
    font-size: var(--step--1);
    transition: background-color 150ms ease;
  }

  .language-switcher__link:hover {
    background-color: #f5f5f5;
  }

  .language-switcher__link.active {
    font-weight: 600;
    color: var(--color-primary);
  }
</style>
