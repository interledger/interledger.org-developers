---
import BaseLayout from '../layouts/BaseLayout.astro'
import Link from '../components/shared/Link.astro'
import HeroSection from '../components/shared/HeroSection.astro'
import Section from '../components/shared/Section.astro'

export const prerender = false
let slug = Astro.originPathname
slug = slug.replace(/^\/|\/$/g, '')
const preview = Astro.url.searchParams.get('preview') ?? false

async function getPageFromStrapi(slug, preview) {
  const token = import.meta.env.STRAPI_PREVIEW_TOKEN
  const base = import.meta.env.STRAPI_URL

  if (!token || !base) {
    throw new Error(`Missing Strapi config: token=${!!token}, url=${!!base}`)
  }

  const query =
    '&populate[hero][populate][hero_call_to_action]=true' +
    '&populate[dynamic]=true'

  const fetch_url = preview
    ? `${base}/api/pages?filters[slug]=${slug}&status=draft` + query
    : `${base}/api/pages?filters[slug]=${slug}` + query

  try {
    const response = await fetch(fetch_url, {
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    if (!response.ok) {
      throw new Error(`Strapi API error: ${response.status}`)
    }
    const data = await response.json()
    return data.data[0]
  } catch (error) {
    console.error('Strapi fetch failed:', error)
    throw error
  }
}

const data = await getPageFromStrapi(slug, preview)
console.log(data)
---

<BaseLayout title={data?.title ?? null} description={data?.description ?? null}>
  {
    data && (
      <main>
        {data.hero && (
          <HeroSection
            title={data.hero.hero_title ?? 'title'}
            content={data.hero.hero_content ?? 'content'}
            ctas={data.hero.hero_call_to_action ?? []}
          />
        )}
        {data.dynamic && (
          <section>
            <div class="content-wrapper">
              {data.dynamic.map((component) => {
                switch (component.__component) {
                  case 'shared.cta-link':
                    return (
                      <Link
                        href={component.link}
                        style={component.style}
                        umami={component.analytics_event_label}
                        external={component.external}
                        text={component.text}
                      />
                    )
                  case 'shared.section':
                    return (
                      <Section
                        title={component.title}
                        content={component.content}
                      />
                    )
                  default:
                    return null
                }
              })}
            </div>
          </section>
        )}
      </main>
    )
  }
</BaseLayout>

<style>
  main {
    padding-block-end: var(--space-l);
  }

  section {
    padding-block-start: var(--space-l);
  }

  section:last-child {
    padding-block-end: var(--space-l);
  }

  .content-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-m);
  }
</style>
