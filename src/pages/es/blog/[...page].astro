---
import type { GetStaticPaths, Page } from 'astro'
import BaseLayout from '../../../layouts/BaseLayout.astro'
import { getCollection } from 'astro:content'
import { useTranslations, getLangFromUrl } from '../../../i18n/utils' // You're here, you already know thisn is ES, can you set this as a var higher up somehow?
import BlogIndex from '../../../components/blog/BlogIndex.astro'

type Props = {
  page: Page
  allTags: string[]
}

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const defaultLang = 'en'
  const blogEntries = await getCollection('blog')
  const allLangs = Array.from(
    new Set(blogEntries.map((entry) => entry.data.lang))
  )
  const langs = allLangs.filter((lang) => lang !== defaultLang)
  return langs.flatMap((lang) => {
    const filteredPosts = blogEntries
      .filter(
        (entry) => entry.data.lang !== defaultLang && entry.data.lang === lang
      )
      .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())

    // Collect all unique tags
    const allTags = [
      ...new Set(filteredPosts.flatMap((entry) => entry.data.tags))
    ].sort()

    return paginate(filteredPosts, {
      pageSize: 10,
      params: { lang },
      props: { allTags }
    })
  })
}

const { page, allTags } = Astro.props
const lang = getLangFromUrl(Astro.url)
const t = useTranslations(lang)
---

<BaseLayout
  title={t('blog.tech-blog-title')}
  description={t('nav.tech-blog-description')}
  ogImageUrl={new URL('/developers/img/blog/og-image.png', Astro.site).href}
>
  <BlogIndex
    title={t('blog.tech-blog-title')}
    posts={page.data || []}
    lang={lang}
    breadcrumbs={[
      {
        name: t('nav.developers'),
        href: `/developers/${lang}`,
        umamiEvent: 'Devs breadcrumb - Home'
      }
    ]}
    allTags={allTags}
    showTagFilter={true}
    showPagination={true}
    paginationProps={{
      length: page.lastPage,
      currentPage: page.currentPage,
      firstUrl: page.url.first,
      prevUrl: page.url.prev,
      nextUrl: page.url.next,
      lastUrl: page.url.last
    }}
  />
</BaseLayout>
